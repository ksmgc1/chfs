<!DOCTYPE html><html><head>
      <title>lab2</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/yangyuhan/.vscode-server/extensions/shd101wyy.markdown-preview-enhanced-0.8.9/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="lab-2-distributed-filesystem">Lab 2: Distributed FileSystem </h1>
<p><strong>Hand out: Sept 24, 2023</strong><br>
<strong>Deadline: Nov 14 23:59 No Extension</strong></p>
<h3 id="lab-2-introduction">Lab 2 Introduction </h3>
<p>In Lab 2, you will implement a distributed file system based on Lab 1. The overall architecture is shown below:</p>
<p><img src="lab2-1.png" alt="overall-arch"></p>
<p>As you can see, this filesystem consists of three components: <strong>filesystem client</strong>, <strong>metadata server</strong>, and <strong>data server</strong>.</p>
<p>In Lab 2, a file is split into one or more blocks, and these blocks are stored on a set of data servers. The filesystem is responsible for serving read and write requests from the filesystem client, as well as instructions like block creation and deletion from the metadata server.</p>
<p>The metadata server is a server that maintains all file system metadata. It stores the inode and other metadata of a file, such as the location of each block (machine id) and the <code>block_id</code> at this machine. Besides, it is responsible for serving metadata operations like file creation, deletion, and querying data block positions for reads and writes. <strong>Note that there is only one metadata server in this lab (no replication).</strong></p>
<p>The filesystem client implements the filesystem logic by issuing RPCs to the metadata server and the data server.</p>
<h3 id="get-the-source-code">Get the Source Code </h3>
<ul>
<li>Pull the source code of lab2 from our GitLab:</li>
</ul>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token builtin class-name">cd</span> chfs <span class="token operator">&amp;&amp;</span> <span class="token function">git</span> pull
</code></pre><ul>
<li>Change it to the lab2 branch</li>
</ul>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout <span class="token parameter variable">-b</span> lab2
</code></pre><ul>
<li>Merge with the code of lab1 and resolve any conflicts on your own if there are any.</li>
</ul>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> merge lab1
</code></pre><ul>
<li>Update submodules as there is a new submodule in lab2:</li>
</ul>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> submodule update <span class="token parameter variable">--init</span> <span class="token parameter variable">--recursive</span>
</code></pre><h3 id="docker-container-development">Docker Container Development </h3>
<p>You can still build the project and test your codes on the same container you used in lab1. Please refer to <a href="../lab1/lab1.md">lab1.md</a> for more details.</p>
<h3 id="implementation">Implementation </h3>
<p>We break down this lab into three parts: First, you should change the single-node filesystem in lab1 to a distributed filesystem by dividing it into data server, metadata server, and filesystem client.<br>
Second, you should implement the lock manager in the metadata server so that the metadata server can handle concurrent requests from multiple clients and ensure before-or-after atomicity for <strong>metadata operations</strong>.<br>
Finally, you need to implement the log manager in the metadata server so that the metadata server can recover from a crash to ensure that <strong>metadata operations</strong> are all-or-nothing.<br>
<strong>Notice</strong>: These components communicate with each other by using RPC (Remote Procedure Call). Please refer to <a href="librpc.md">librpc.md</a> for more details about the RPC module. <strong>And there's an important assumption in this lab that RPC won't fail.</strong></p>
<h3 id="compile-code-and-test">Compile Code And Test </h3>
<p>Please also refer to <a href="../lab1/lab1.md">lab1.md</a> for more details. It's the same with lab1.</p>
<hr>
<h2 id="demo">Demo </h2>
<p>After finishing lab2, you can use the filesystem implemented by yourself like lab1. Follow these steps:</p>
<ul>
<li>
<p>Under <code>chfs</code> directory, execute:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>./scripts/lab2/start_fs.sh 
</code></pre></li>
<li>
<p>After the script returns, there will be a <code>mnt</code> directory inside <code>chfs</code> directory.</p>
</li>
<li>
<p>Enter the <code>mnt</code> directory. The filesystem you have implemented is mounted to this directory, which means that every filesystem request inside this directory will be fulfilled by the filesystem you have implemented.</p>
</li>
<li>
<p>You can create a new directory:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">mkdir</span> my_dir 
</code></pre></li>
<li>
<p>Then you can create a new file inside the newly created directory:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">touch</span> my_dir/a.txt 
</code></pre></li>
<li>
<p>Check whether the file is created successfully:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">ls</span> my_dir 
</code></pre></li>
<li>
<p>After that, you can write something into this file:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token builtin class-name">echo</span> <span class="token string">"foo"</span> <span class="token operator">&gt;&gt;</span> my_dir/a.txt
<span class="token builtin class-name">echo</span> <span class="token string">"bar"</span> <span class="token operator">&gt;&gt;</span> my_dir/a.txt
</code></pre></li>
<li>
<p>Read the file, then you will see the contents you have just written:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">cat</span> my_dir/a.txt 
</code></pre></li>
<li>
<p>Then if you do not need this file anymore, delete it:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">rm</span> my_dir/a.txt 
</code></pre></li>
</ul>
<p>You can refer to the <code>daemons/distributed/main.cc</code> if you are interested.</p>
<h2 id="part-1-distributed-filesystem">Part 1: Distributed filesystem </h2>
<h3 id="part-1a-data-server">Part 1A: Data Server </h3>
<p>In Part 1A, you will implement the data server that manages the file data. You have to implement the following functions inside <code>src/distributed/dataserver.cc</code> (You can only modify this file, do not modify any others so as to fulfill this part) :</p>
<ul>
<li><code>read_data</code>: Read a piece of data in a block from the block device, provided the offset and the length of the block.</li>
<li><code>write_data</code>: Write a partial block to the block device, provided the offset and length of the written contents in the block.</li>
<li><code>alloc_block</code>: Create an empty block.</li>
<li><code>free_block</code>: Clear the contents of a block.</li>
</ul>
<p>You may refer to the definition of class <code>DataServer</code> and the comments of these functions in <code>src/include/distributed/dataserver.h</code> for more detailed information. These functions are trivial to implement based on lab1. The only difference is they are <strong>remote calls</strong>.</p>
<p>If your implementation is correct, you should pass the unit tests (in  <code>test/distributed/dataserver_test.cc</code>):</p>
<ul>
<li><code>DataServerTest.AllocateAndDelete</code></li>
<li><code>DataServerTest.ReadAndWrite</code></li>
</ul>
<h3 id="part-1b-metadata-server">Part 1B: Metadata Server </h3>
<p>In Part 1B, you will implement the metadata server operations.  We have provided the layout of blocks of the metadata server below, which is very similar to lab1:</p>
<p><img src="lab2-meta-arch.jpg" alt="lab2-meta-arch"></p>
<p>For directory inode, it saves all its direct and indirect block id like lab1. For file inode, it saves the mappings of all its blocks. You may refer to the definition of class <code>MetadataServer</code> and the comments of these functions in <code>src/include/distributed/metadata_server.h</code> for more detailed information.</p>
<p>You need to implement the following functions inside <code>src/distributed/metadata_server.cc</code> and <code>src/distributed/dataserver.cc</code>(You can modify some files in lab1 to support regular file's inode block architecture) . <strong>Hint</strong>: most functions follow a nearly identical implementation as lab1.</p>
<ul>
<li><code>mknode</code>: Create an inode with the given type, name, and parent.</li>
<li><code>unlink</code>: Delete a file from its parent.</li>
<li><code>lookup</code>: Try to search an inode by its name and its parent.</li>
<li><code>allocate_block</code>: Allocate a block of a file so the client can write data to the block.</li>
<li><code>free_block</code>: Free a block of a file on a data server and delete its record on the metadata server.</li>
<li><code>readdir</code>: Read the content of a directory.</li>
<li><code>get_block_map</code>: Return the block mapping of an inode. It contains the block id and machine id of each block.  <strong>Note</strong> that for each of the blocks, this function will also return the version of it, which is not needed right now. You may simply return 0 to pass the tests for now. Part 1C will describe the version in more detail.</li>
<li><code>get_type_attr</code>: Get the type and attribute of an inode. <strong>Hint: in this lab, you can simply calculate the file's size by its block number</strong></li>
</ul>
<p>If your implementation is correct, you should pass the unit tests:</p>
<ul>
<li><code>MetadataServerTest.CreateDirThenLookup</code></li>
<li><code>MetadataServerTest.WriteAnEmptyFile</code></li>
<li><code>MetadataServerTest.CheckPersist</code></li>
<li><code>MetadataServerTest.CheckReadDir</code></li>
<li><code>MetadataServerTest.CheckUnlink</code></li>
</ul>
<p>You may refer to <code>test/distributed/metadata_server_test.cc</code> for the detailed implementation of these tests to help you debug.</p>
<h3 id="part-1c-filesystem-client">Part 1C: Filesystem Client </h3>
<p>In Part 1C, you will implement the filesystem client that is responsible for all kinds of file operations, e.g., create/delete a file and read/write some contents in it. You may refer to the definition of class <code>ChfsClient</code> and the comments of these functions in <code>src/include/distributed/client.h</code> for more detailed information.</p>
<p>You need to implement the following functions inside <code>src/distributed/client.cc</code> (You only need to modify this file to pass this part) :</p>
<ul>
<li><code>mknode</code>: Create an inode with the given type, name, and parent.</li>
<li><code>unlink</code>: Delete a file from its parent.</li>
<li><code>lookup</code>: Try to search an inode by its name and its parent.</li>
<li><code>readdir</code>: Read the content of a directory.</li>
<li><code>get_type_attr</code>: Get the type and attribute of an inode.</li>
<li><code>read_file</code>: Read the contents of a file.</li>
<li><code>write_file</code>: Write the contents of a file.</li>
<li><code>free_file_block</code>: Free a block of a file and delete its record on the metadata server.</li>
</ul>
<p><strong>Notice on the implementation of read/write file</strong>: Like GFS, if a client wants to read/write a file, it should first get the block mapping (block ids of the block belonging to this file) from the metadata server. Then it can directly send read/write requests to the corresponding blocks on data servers. If the client wants to write an empty file, it should first call the metadata server to allocate a block on a data server.</p>
<p>Due to this separate design, a tricky case is that there would be distributed before-or-after atomicity issues. If a client first gets the mapping of file A, another client deletes file A, and finally a third client creates a new file based on the old mapping of file A, the first client may read the wrong data. Therefore, you need to implement a version mechanism to detect such a race condition. Specifically, each block has a version number, which is stored together with the block at the data server, shown below.  Based on the version, the metadata server will also store the versions of blocks belonging to a file. These versions will be returned as a part of the mapping to the client.</p>
<p>If a block no longer belongs to a file, we will first increment the block version on the dataserver. Based on this scheme, we can detect the above race by letting the data server reject block read/write requests with a mismatched version.</p>
<p><img src="lab2-data-arch.png" alt="lab2-data-arch"></p>
<p>To realize the above method, you need to refine the implementations of the below functions:</p>
<ul>
<li><code>DataServer::DataServer</code>: Add anything you want to persist the version of blocks on disk in the constructor.</li>
<li><code>DataServer::read_data</code>: Check whether the version is valid or not.</li>
<li><code>DataServer::alloc_block</code>: Allocate a block and update its version.</li>
<li><code>DataServer::free_block</code>: Deallocate the block and update its version.</li>
<li><code>MetadataServer::get_block_map</code>: Return the version of the block to the client too.</li>
<li><code>MetadataServer::allocate_block</code>: Record the version of the block too.</li>
</ul>
<p>If your implementation is correct, you should pass the following unit tests:</p>
<ul>
<li><code>DistributedClientTest.WriteAndThenRead</code></li>
<li><code>MetadataServerTest.ReadWhenBlockIsInvalid</code></li>
</ul>
<p>You may refer to <code>test/distributed/distributed_client_test.cc</code> for the detailed implementation of these tests to help you debug.</p>
<h2 id="part-2-support-concurrency">Part 2: Support Concurrency </h2>
<p>In part2, we will handle the client's RPC concurrently with multiple threads. Your task in this part is to add locks in this system to keep the <strong>Before-or-After</strong> atomicity on these <strong>metadata operations</strong>. The usage of the locking method is based on you (e.g., 2PL, global lock, etc.) Hint: you can use <code>c++ mutex</code>.</p>
<p>If your implementation is correct, you should pass:</p>
<ul>
<li><code>DistributedClientTest.CreateConcurrent</code></li>
<li><code>DistributedClientTest.ReCreateWhenDelete</code></li>
<li><code>MetadataServerTest.CheckInvariant1</code></li>
<li><code>MetadataServerTest.CheckInvariant2</code></li>
<li><code>MetadataServerTest.CheckInvariant3</code></li>
<li><code>MetadataServerTest.CheckInvariant4</code></li>
</ul>
<p>You may refer to <code>test/distributed/distributed_client_test.cc</code> and <code>test/distributed/metadata_server_test.cc</code> for the detailed implementation of these tests to help you debug.</p>
<p>Finally,  you need to pass the following stress test.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">make</span> run_concurrent_stress_test
</code></pre><p><strong>Notice for bonus</strong>: Before-or-after atomicity is easy to implement: just using a global lock to protect every operation. However, it may cause a performance drop. It's ok to use a global lock and you can get <strong>95% points for this part</strong>. But you can get at most <strong>5% bonus score</strong> if you use more fine-grained locks. We will evaluate your implementation using a stress test in <code>stress-test/concurrent.cc</code> with our solutions (you can also see your implementation's performance via <code>make run_concurrent_stress_test</code>). If the time it takes for your implementation to run the stress test is <strong>1/2</strong> of the time for a global lock implementation, you can get <strong>100 points</strong>.</p>
<hr>
<h2 id="part-3-recover-after-crash">Part 3: Recover after crash </h2>
<p>Finally, we will use <strong>redo-logging</strong> to ensure filesystem <strong>metadata</strong> operations are all-or-nothing atomic.<br>
Before you start this part, you should first learn the following assumptions:</p>
<ul>
<li>The data you write into the disk by calling <code>BlockManager::write_block</code> aren't persisted to disk immediately. These changes stay on the page cache until they're flushed to disk. In this lab, we've provided two interfaces for flushing data to disk: <code>BlockManager::sync</code> and <code>BlockManager::flush</code>. The former flushes a specific block to disk, and the latter flushes the page cache to disk. The data are persisted to disk after these calls return. You can directly use them in this part.</li>
<li>Writing data to a block is atomic. That is, if you write data to a block, the data will be either fully written or not written at all.</li>
</ul>
<h3 id="part-3a-log-manager">Part 3A: Log Manager </h3>
<p>For simplicity, we just use a block-level value log to record operations. This means that we only record the updated block values in the log. For example, if someone creates a file, it will update at least 3 blocks, so the log will contain 3 new blocks.</p>
<p>At first, you should modify the <code>BlockManager</code> to support storing the log on disk, which means that you should reserve some blocks on disk for persisting log. In this lab, you will need to reserve 1024 blocks for the log.<br>
Then you have to implement the following functions inside <code>src/distributed/commit_log.cc</code>. We've provided a class <code>BlockOperation</code> to record one block value change. But how to get the block value changes and how to store the log on disk is up to you. <strong>Hint: you should still keep the before-or-after atomicity in this part</strong></p>
<ul>
<li><code>append_log</code>: Write the block value changes into the disk for persistence.</li>
<li><code>recover</code>: Read the block value changes from disk and redo the operation for all-or-nothing atomicity.</li>
</ul>
<p>You may refer to <code>src/include/distributed/commit_log.h</code> for more information on these functions.</p>
<p>Afterward, you may need to modify the following metadata functions' implementations to use the above functions (<strong>Note, you only need to ensure the atomicity of the following two functions</strong>):</p>
<ul>
<li><code>MetadataServer::mknode</code></li>
<li><code>MetadataServer::rmnode</code></li>
</ul>
<p>If your implementation is correct, you should pass:</p>
<ul>
<li><code>CommitLogTest.CheckConcurrent</code></li>
<li><code>CommitLogTest.CheckConcurrentUnlink</code></li>
<li><code>CommitLogTest.CheckRecoverFromFailure</code></li>
</ul>
<p>You may refer to <code>test/distributed/commit_log_test.cc</code> for the detailed implementation of these tests to help you debug.</p>
<h3 id="part-3b-checkpoint">Part 3B: Checkpoint </h3>
<p>As we have learned in class, storing logs could consume a lot of disk space. So we need to implement checkpoint to reduce the log size. In this part, you should implement these functions in <code>src/distributed/commit_log.cc</code>:</p>
<ul>
<li><code>commit_log</code>: It marks one transaction as finished.</li>
<li><code>checkpoint</code>: Write all the finished transactions' modifications to the disk and discard their logs.</li>
<li><code>get_log_entry_num</code>: Return the number of log entries in the disk.</li>
</ul>
<p>If your implementation is correct, you should pass:</p>
<ul>
<li><code>CommitLogTest.CheckCheckpointFunctional</code></li>
</ul>
<h2 id="run-integration-test">Run Integration Test </h2>
<p>Like lab1, we also use <a href="http://libfuse.github.io/doxygen/index.html">the libfuse userspace library</a> provided by FUSE (Filesystem in Userspace) to implement the adaptor layer. You can refer to <code>daemons/distributed/main.cc</code> for the detailed implementation.</p>
<p>Running the integration test is a little bit different from lab1. We use <code>docker compose</code> to set up the environment. To launch the environment, start a shell and execute the following command under the <code>scripts/lab2</code> directory:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">docker</span> compose up
</code></pre><p>After this, all containers are launched and initiated. You can use <code>docker ps</code> to check the status of containers. Then open another shell and execute the following command to enter the container that mounts the filesystem:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> lab2-fs_client-1 <span class="token function">bash</span>
</code></pre><p>The mount point is at <code>/tmp/mnt</code> in the <code>lab2-fs_client-1</code> container and you can run scripts under the <code>~/chfs/scripts/lab2</code> directory to do the integration test just like lab1.</p>
<h2 id="grading">Grading </h2>
<p>After you have finished all parts, firstly, compile your code by executing the following commands under the <code>build</code> directory:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">make</span> <span class="token parameter variable">-j</span>
<span class="token function">make</span> build-tests <span class="token parameter variable">-j</span>
</code></pre><p>Then, for unit tests, execute the following command under the <code>build</code> directory:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">make</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-j</span>
</code></pre><p>For the stress test's correctness, execute the following command under the <code>build</code> directory:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">make</span> run_concurrent_stress_test
</code></pre><p>For the integration tests, execute the following command under the <code>scripts/lab2</code> directory:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>./integration_test.sh
</code></pre><h2 id="handin">Handin </h2>
<p>Execute the following command under the <code>scripts/lab2</code> directory:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>./handin.sh
</code></pre><p>Then you will see a <code>handin.tgz</code> file under the root directory of this project. Please rename it in the format of: <code>lab2_[your student id].tgz</code>, and upload this <code>.tgz</code> file to Canvas.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>